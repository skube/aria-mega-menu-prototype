<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>Document</title>
	<base href="http://gm.ca">

	<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<style type="text/css">

	body { font-family: 'Lato', sans-serif; margin: 0;padding: 0;}
	a {display: inline-block;}
	button {cursor: pointer;}

	.wrap {width: 990px; margin: 0 auto;}

	/* TODO namespace menu */
	.accessible-div-nav {background: red;}

	/*.menu-focus,*/
	*[role='navigation'] :focus {outline: 2px solid blue; transition: all 0.2s;}

	.adn-mask {display:none; position: fixed; top: 0; left: 0; opacity: 0.5; 
  -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";/* IE 8 */
   width: 100%; height: 100%; background: #000;}
	
	.menubar {
		position: relative;
		margin: 0;
		padding: 0;
		list-style: none;
		border: 1px solid black;
		background: #589494;
	}
	.menubar > li {
		float: left;
		margin: 0;
		padding: .25em .35em;
	}
	.cat-thumbs {
		position: absolute;
		top:4em;
		left: 0;
		width: 990px;
		margin: 0;
		padding: 0;
		list-style: none;
		background: #8EBBB4;
	}
	.cat-thumbs > li {
		float: left;
		list-style: none;
		color: black;
	}

	.cat-thumbs .dimmed {
		opacity: 0.2;
		-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=20)"; /* IE 8 */
	}
	.cat-thumbs .dimmed:focus,
	.cat-thumbs .dimmed:hover {
		opacity: 1;
		-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=100)"; /* IE 8 */
	}

	.vert-menu {
	   position: absolute;
		top:2em;
		width: 176px;
		margin: 0;
		padding: 0;
		list-style: none;
		background: #ccc;
	}

	.vert-menu > li {
		list-style: none;
		padding: 2px 1em;
		color: black;
	}

	.opt-trim {
		position: absolute;
		left: 0;
		width: 990px;
		margin: 0;
		padding: 0;
		background: #D0DCD0;
	}

	.trims, .menu-description {
		float: left;
		padding: .25em;
		list-style: none;
	}

	.panel-content {
		position: absolute;
		left:0;
		width: 990px;
		margin: 0;
		padding: 0;
		list-style: none;
		background: #F5EED2;
	}

	.menu[aria-hidden="true"], .panel-content[aria-hidden="true"] {
	   display: none;
	}

	.menu-hover {
	}

	.menu-hover[aria-checked="true"] {
	}


	li[aria-checked="true"]
	{
		background: yellow;
	}

	.hidden {
	   position: absolute;
	   left: -200em;
	   top: -20em;
	}

	.upcoming {
		position: absolute;
		background: green;
	}
	.upcoming > * {
		float: left;
		margin: 0 1em;
		padding: 0;
	}

	.clearfix:before,
	.clearfix:after {
		content: " ";
		display: table;
	}
	.clearfix:after {
		clear: both;
	}

</style>

</head>
<body class="wrap">

	<!-- Start Accessible Div Nav -->
	<div role="navigation" class="accessible-div-nav">

		<div class="adn-mask" aria-hidden="true"></div>

		<a id="div-logo" href="/gm/english/vehicles/chevrolet/"><img src="/images/divisional/chevrolet/chevrolet_logo_background_2014.gif" alt="Chevrolet" title="Chevrolet"></a>

		<ul id="accessible-div-nav" class="root-level menubar clearfix" role="menubar">

			<li class="menu-parent" role="menuitem" aria-haspopup="true" tabindex="0" aria-expanded="false">
				<button>CARS</button>
			   <dl class="menu upcoming" role="menu" aria-hidden="true">
					<dt id="adn_cars_upcoming_desc">upcoming vehicles</dt>
					<dd class="menu-item" role="menuitem" tabindex="-1" aria-label="Upcoming Vehicles - future"><a href="http://google.ca">future</a></dd>
					<dd class="menu-item" role="menuitem" tabindex="-1" aria-describedby="adn_cars_upcoming_desc"><a href="#">future</a></dd>
					<dd class="menu-item" role="menuitem" tabindex="-1" aria-describedby="adn_cars_upcoming_desc"><a href="#">future</a></dd>
					<dd class="menu-item" role="menuitem" tabindex="-1" aria-describedby="adn_cars_upcoming_desc"><a href="#">future</a></dd>
				</dl>
				<ul class="cat-thumbs menu" role="menu" aria-hidden="true">
					<li class="menu-parent menu-item" role="menuitem" aria-haspopup="true" aria-expanded="false" tabindex="-1">
						<button>
							<img src="/images/divisional/chevrolet/vehicles/divnav_thumb_chev_spar_on.jpg" alt="">
							<h4>car.</h4>
							<p>from $29,000</p>
						</button>
						<ul class="opt-trim menu" role="menu" aria-hidden="true">
							<li class="menu-description" id="adn_cars_trim_01_desc" role="presentation">select a model</li>
							<li class="menu-parent menu-item trims" role="menuitem" aria-haspopup='true' tabindex="-1" aria-expanded="false" aria-describedby="adn_cars_trim_01_desc">
								<button>TRIM1</button>
								<div class="menu panel-content" aria-hidden="true" tabindex="-1">
									<h4 tabindex="-1">Orlando 2014</h4>
									<p>CONTENT1 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Culpa, atque, quaerat libero aspernatur provident ullam quos et a! Ab porro rerum cupiditate laudantium soluta voluptate aut blanditiis fugit dolorem amet.
									<button type="button">learn more</button>
									<input type="text" class="postal-code-input">
									<a href="#">change</a>
									</p>
								</div>
							</li>
							<li class="menu-parent menu-item trims" role="menuitem" aria-haspopup='true' tabindex="-1">
								<button>TRIM2</button>
								<div class="menu panel-content" aria-hidden="true" tabindex="-1">

									<div class="trim_2014_chev_trax">

										<div class="vehicleNameContainer">2014 Trax </div>
										
											<div class="learnMore">
												<div class="lm">
													<a href="/gm/english/vehicles/chevrolet/trax/overview">Learn More</a>
												</div>
											</div>
										
											<div class="msrp">MSRP From $18,695 <sup>Ω</sup></div>
										
											<p class="pc">Enter your postal code to see local offers: 
												<span class="basePC">POSTAL CODE</span> (<a class="changePC" href="#">Change</a>)
											</p>
											<form>
												<p class="pcSubmit">Enter your postal code to see local offers: 
													<input type="text" name="flyout-pc" class="flyout-pc" maxlength="7"> 
													(<a href="#" class="submitPC">Submit</a>)
												</p>
											</form>						
																								
											<p class="infoTxt">Trax is the right-sized crossover that delivers the manoeuvrability you need for city streets, combined with an unsurpassed highway fuel efficiency rating of just 5.7 L/100 km.<sup>1</sup> Take to the streets – and roads – with confidence in the 2014 Chevrolet Trax.</p>
																
											<div class="hockeyCard">
												<a href="/gm/english/vehicles/chevrolet/trax/overview"><img src="/images/divisional/chevrolet/vehicles/chev_trax_hockey_card.jpg" alt="" title=""></a>
											</div>																	
														
											<!-- specs  start-->
											<div class="specsBoxes">
												<div class="specBox">
													<div class="specBox-fuel-efficiency">
														<div class="title">Fuel Efficiency</div>
														<div class="fuel-efficiency"></div>
														<div class="amt">5.7
															<div class="feature">L/100km hwy<sup>1</sup></div>
														</div>
													</div>
												</div>
												<div class="specBox">
													<div class="specBox-interior-volume">
														<div class="title">Cargo Volume</div>
														<div class="interior-volume"></div>
														<div class="amt">1,371
															<div class="feature">L (48.4 cu. ft.)</div>
														</div>
													</div>
												</div>
												<div class="specBox">
													<div class="specBox-turbo-engine">
														<div class="title">Standard</div>
														<div class="turbo-engine"></div>
														<div class="amt">Turbo
															<div class="feature">engine</div>
														</div>
													</div>
												</div>
											</div>
											<!-- specs  end-->

									</div>

								</div>
							</li>
							<li class="menu-parent menu-item trims" role="menuitem" aria-haspopup='true' tabindex="-1">
								<button>TRIM3</button>
								<div class="menu panel-content" aria-hidden="true" tabindex="-1">
									<h4 tabindex="-1">Sonic 2014</h4>
									<p>CONTENT1 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Culpa, atque, quaerat libero aspernatur provident ullam quos et a! Ab porro rerum cupiditate laudantium soluta voluptate aut blanditiis fugit dolorem amet.
									<button type="button">learn more</button>
									<input type="text" class="postal-code-input">
									<a href="#">change</a>
									</p>
								</div>
							</li>
					   </ul>
					</li>
					<li class="menu-parent menu-item" role="menuitem" aria-haspopup="true" tabindex="-1">
						<button>
							<img src="/images/divisional/chevrolet/vehicles/divnav_thumb_chev_soni_on.jpg" alt="">
							<h4>Sonic</h4>
							<p>from $29,000</p>
						</button>
						<div class="menu panel-content" aria-hidden="true" tabindex="-1">
							<h4 tabindex="-1">Spark 2014</h4>
							<p>CONTENT1 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Culpa, atque, quaerat libero aspernatur provident ullam quos et a! Ab porro rerum cupiditate laudantium soluta voluptate aut blanditiis fugit dolorem amet.
							<button type="button">learn more</button>
							<input type="text" class="postal-code-input">
							<a href="#">change</a>
							</p>
						</div>
					</li>
					<li class="menu-parent menu-item" role="menuitem" aria-haspopup="true" tabindex="-1">
						<button>
							<img src="/images/divisional/chevrolet/vehicles/divnav_thumb_chev_cruz_on.jpg" alt="">
							<h4>car.</h4>
							<p>from $29,000</p>
						</button>
						<div class="menu panel-content" aria-hidden="true" tabindex="-1">
							<h4 tabindex="-1">Cruze 2014</h4>
							<p>CONTENT1 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Culpa, atque, quaerat libero aspernatur provident ullam quos et a! Ab porro rerum cupiditate laudantium soluta voluptate aut blanditiis fugit dolorem amet.
							<button type="button">learn more</button>
							<input type="text" class="postal-code-input">
							<a href="#">change</a>
							</p>
						</div>
						</li>
				</ul>
			</li>
			<!-- Vertical Menus -->
			<li class="menu-parent" role="menuitem" aria-haspopup="true" tabindex="-1">
				<button>HIGHLIGHTS</button>
				<ul class="menu vert-menu"  role="menu" aria-hidden="true">
					<li class="menu-item" role="menuitem"  tabindex="-1">
						<a href="#">lorem</a>
					</li>
					<li class="menu-item" role="menuitem"  tabindex="-1">
						<a href="http://skube.com">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>
					</li>
					<li class="menu-item" role="menuitem"  tabindex="-1">
						<a href="#">lorem</a>
					</li>
					<li class="menu-item" role="menuitem"  tabindex="-1">
						<a href="#">lorem</a>
					</li>
				</ul>
			</li>



		</ul>

	</div>

	<div class="wrap" style="clear:both">
		<h1>Some header</h1>
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Numquam, atque ipsam totam earum quam obcaecati quisquam commodi odit consequatur debitis quas  facere omnis repudiandae voluptatem sint minima aspernatur. Ducimus, magnam.</p>
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Numquam, atque ipsam totam earum quam obcaecati quisquam commodi odit consequatur debitis quas  facere omnis repudiandae voluptatem sint minima aspernatur. Ducimus, magnam.</p>
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Numquam, atque ipsam totam earum quam obcaecati quisquam commodi odit consequatur debitis quas  facere omnis repudiandae voluptatem sint minima aspernatur. Ducimus, magnam.</p>
		<label for="">some input <input type="text"></label>
	</div>

<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>


<script>


	$(document).ready(function() {
		var menu1 = new Menubar('accessible-div-nav', false);

	}); // end ready()

	/////////////// begin menu widget definition /////////////////////
	//
	// Function Menubar() is the constructor of a menu widget
	// The widget will bind to the ul passed to it.
	//
	// @param(id string) id is the HTML id of the ul to bind to
	// @param(vmenu boolean) vmenu is true if menu is vertical; false if horizontal
	// @return N/A
	function Menubar (id, vmenu) {

		// define widget properties
		this.$id = $('#' + id);

		this.$rootItems = this.$id.children('li'); // jQuerry array of all root-level menu items

		this.$items = this.$id.find('.menu-item').not('.separator'); // jQuery array of menu items
		this.$parents = this.$id.find('.menu-parent'); // jQuery array of menu items
		this.$allItems = this.$parents.add(this.$items); // jQuery array of all menu items
		this.$activeItem = null; // jQuery object of the menu item with focus

		this.$upcoming = this.$id.find('.upcoming'); // TODO update to $item's upcoming instead
		this.$catThumbs = this.$id.find('.cat-thumbs');
		this.isInPanel = false; // track whether currently inside panel-content
		this.panelItemIndex = -1; // which element has focus inside panel-content

		this.vmenu = vmenu; // TODO remove all vmenu references
		this.bChildOpen = false; // true if child menu is open

		this.keys = {
			TAB:    9,
			ENTER:  13,
			ESC:    27,
			SPACE:  32,
			LEFT:   37,
			UP:     38,
			RIGHT:  39,
			DOWN:   40
		};

		// bind event handlers
		this.bindHandlers();

		// associate the menu with the textArea it controls
		// this.textarea = new textArea(this.$id.attr('aria-controls'));
	}

	// Function bindHandlers() is a member function to bind event handlers for the widget.
	// @return N/A
	Menubar.prototype.bindHandlers = function() {

		var thisObj = this;

		///////// bind mouse event handlers //////////

		// bind a click handler
		this.$allItems.click(function(e) {
			return thisObj.handleClick($(this), e);
		});

		//////////// bind key event handlers //////////////////

		// bind a keydown handler
		this.$allItems.keydown(function(e) {
			return ($(e.target).is('input')) ? true : thisObj.handleKeyDown($(this), e);
		});

		// bind a keypress handler
		this.$allItems.keypress(function(e) {
			return ($(e.target).is('input')) ? true : thisObj.handleKeyPress($(this), e);
		});

		// bind a focus handler
		this.$allItems.focus(function(e) {
			return thisObj.handleFocus($(this), e);
		});

		// bind a blur handler
		this.$allItems.blur(function(e) {
			return thisObj.handleBlur($(this), e);
		});

		// bind a document click handler
		$(document).click(function(e) {
			return thisObj.handleDocumentClick(e);
		});

	}; // end bindHandlers()


	// Function handleClick() is a member function to process click events
	// for the top menus.
	// @param($item object) $item is the jquery object of the item firing the event
	// @param(e object) e is the associated event object
	// @return(boolean) Returns false;
	Menubar.prototype.handleClick = function($item, e) {

		var
			$parent = $item.parent();

		// TODO e.target is within panel-content
		if ($(e.target).parents('.panel-content').length || $parent.is('.vert-menu')) {
			// e.target.focus();
			e.stopPropagation ? e.stopPropagation() : (e.cancelBubble=true); // IE<9?
			if ($(e.target).is('a, button') || e.target.parentNode.tagName == "A") {
				this.processMenuChoice($item);
				return true;
			} 
		} else {
			if ($parent.is('.root-level')) {
				$('.adn-mask').show();
			}

			// Hide others
			$item.siblings()
				.removeClass('.menu-focus').attr('aria-checked', false).attr('aria-expanded',false)
				.children().attr('aria-hidden', true);

			// Show all children
			$item.focus().attr('aria-checked', true).attr('aria-expanded',true).addClass('menu-focus')
				.children().attr('aria-hidden', 'false');

			this.isInPanel = false;
			this.panelItemIndex = -1;

			// if clicking cat-thumbs, and if no trims selected, select first & show panel-content
			if ($parent.is('.cat-thumbs')) {
				var $itemTrims = $item.children().children('.menu-item');
				if ( $itemTrims.filter('[aria-checked=true]').length ) {
					$itemTrims.filter('[aria-checked=true]').children('.panel-content').attr('aria-hidden',false);
				} 
				else {
					$itemTrims.first().attr('aria-checked',true).children('.panel-content').attr('aria-hidden',false);
				}
				// set siblings to dimmed
				this.$catThumbs.children().removeClass('dimmed').end().children('[aria-checked=false]').addClass('dimmed');
				e.stopPropagation ? e.stopPropagation() : (e.cancelBubble=true); // IE<9?
				return false;
			}

			/* if ($parentUL.is('.root-level')) {
				// open the child menu if it is closed
				$item.children('ul').first().attr('aria-hidden', 'false');
			}*/
			else if ($parent.is('.upcoming')){
				// process the menu choice
				// this.processMenuChoice($item);

				// remove hover and focus styling
				// this.$allItems.removeClass('menu-hover menu-focus');

				// close the menu
				// this.$id.find('ul').not('.root-level').attr('aria-hidden','true');
				// move focus to the text area
				// this.textarea.$id.focus();
				e.stopPropagation ? e.stopPropagation() : (e.cancelBubble=true); // IE<9?
				return true;
			} else {
				e.stopPropagation ? e.stopPropagation() : (e.cancelBubble=true); // IE<9?
				return false;
			}			
		}




	}; // end handleClick()

	// Function handleFocus() is a member function to process focus events
	// for the menu.
	// @param($item object) $item is the jquery object of the item firing the event
	// @param(e object) e is the associated event object
	// @return(boolean) Returns true;
	Menubar.prototype.handleFocus = function($item, e) {

		// if activeItem is null, we are getting focus from outside the menu. Store
		// the item that triggered the event
		if (this.$activeItem == null) {
			this.$activeItem = $item;
		}
		else if ($item[0] != this.$activeItem[0]) {
			return true;
		}

		// get the set of jquery objects for all the parent items of the active item
		var $parentItems = this.$activeItem.parentsUntil('div').filter('li');

		// remove focus styling from all other menu items
		this.$allItems.removeClass('menu-focus');

		// add focus styling to the active item
		this.$activeItem.addClass('menu-focus');

		// add focus styling to all parent items.
		// $parentItems.addClass('menu-focus');

		/*if (this.vmenu == true) {
		  // if the bChildOpen flag has been set, open the active item's child menu (if applicable)
		  if (this.bChildOpen == true) {

			 var $itemUL = $item.parent();

			 // if the itemUL is a root-level menu and item is a parent item,
			 // show the child menu.
			 if ($itemUL.is('.root-level') && ($item.attr('aria-haspopup') == 'true')) {
				$item.children('ul').attr('aria-hidden', 'false');
			 }
		  }
		  else {
			 this.vmenu = false;
		  }
		}*/

	   return true;
	}; // end handleFocus()

	// Function handleBlur() is a member function to process blur events
	// for the menu.
	// @param($item object) $item is the jquery object of the item firing the event
	// @param(e object) e is the associated event object
	// @return(boolean) Returns true;
	Menubar.prototype.handleBlur = function($item, e) {

	   $item.removeClass('menu-focus');

	   return true;
	}; // end handleBlur()

	// Function handleKeyDown() is a member function to process keydown events
	// for the menus.
	// @param($item object) $item is the jquery object of the item firing the event
	// @param(e object) e is the associated event object
	// @return(boolean) Returns false if consuming; true if propagating
	Menubar.prototype.handleKeyDown = function($item, e) {

		if (e.altKey || e.ctrlKey ||  $(e.target).is('input') ) {
			// Modifier key pressed: Do not process
			return true;
		}
		var 
			$parent     = $item.parent(),
			numChildren = $parent.children().length,
			isLastItem  = ($item.index() === numChildren-1) ? true : false,
			isFirstItem = ($item.index() === 0) ? true : false;

		switch(e.keyCode) {

			case this.keys.TAB:

				// if at last or first item (going backwards), then move off navigation
				if ( $parent.is('.root-level') && ( (isLastItem && !e.shiftKey) || (isFirstItem && e.shiftKey) ))  {
					
					this.$id.find('ul').add('dl').attr('aria-hidden', 'true');
					this.$allItems.removeClass('menu-focus').attr('aria-checked',false);
					$('.adn-mask').hide();

					this.$activeItem = null;
					this.bChildOpen = false;
					return true; // exit function
				} 
				else if ( $parent.is('.upcoming') && isLastItem && !e.shiftKey) {
					// move on to cat-thumbs
					this.$activeItem = this.moveDown($item);
				}
				else if (this.isInPanel) {
					this.$activeItem = (e.shiftKey) ? this.determineNextTabbable($item, "backward"): this.determineNextTabbable($item);
				}
				else {
					if (e.shiftKey) {
						this.$activeItem = ($parent.is('.vert-menu')) ? this.moveUpToPrev($item) : this.moveToPrevious($item);
					} else {
						this.$activeItem = ($parent.is('.vert-menu')) ? this.moveDownToNext($item) : this.moveToNext($item);
					}
				}

				// sets focus to returned item
				this.$activeItem.focus();
				e.stopPropagation();
				return false;

			case this.keys.ESC:
				// upcoming is unique
				if ( $parent.is('.upcoming') ) {
					$item.parent().siblings().find('[aria-checked=true]').attr('aria-checked',false).find('.opt-trim').attr('aria-hidden',true);
					this.$catThumbs.children().removeClass('dimmed');
				}
				else { // un-check self and siblings, hide all children
					$item.siblings().andSelf().attr('aria-checked',false).children().attr('aria-hidden',true).attr('aria-expanded',false);
					// set siblings to dimmed
					if ( !$parent.is('.root-level') ) {
						this.$catThumbs.children().removeClass('dimmed');
					}
				}
				// move up one level
				this.$activeItem = $parent.parent();
				// reset the bChildOpen flag
				this.bChildOpen = false;
				this.isInPanel = false;
				this.panelItemIndex = -1;
				// set focus on the new item
				this.$activeItem.focus().attr('aria-checked',false).attr('aria-expanded',false);
				
				if ( $parent.is('.root-level') ) { 
					$('.adn-mask').hide();
					$item.attr('aria-expanded',false);
				}

				e.stopPropagation();
				return false;

			case this.keys.RIGHT:
				// if (this.vmenu == true && $itemUL.is('.root-level')) {
				//     // If this is a vertical menu and the root-level is active, move
				//     // to the next item in the menu
				//     this.$activeItem = this.moveDown($item);
				// }
				// else {
				//     this.$activeItem = this.moveToNext($item);
				// }
				this.$activeItem = ($parent.is('.vert-menu')) ? this.moveDownToNext($item) : this.moveToNext($item);

				// sets focus to returned item
				this.$activeItem.focus();
				e.stopPropagation();
				return false;				
				
			case this.keys.LEFT:
				// if (this.vmenu == true && $itemUL.is('.root-level')) {
				// // If this is a vertical menu and the root-level is active, move
				// // to the previous item in the menu
				// this.$activeItem = this.moveUp($item);
				// }
				// else {
				//     this.$activeItem = this.moveToPrevious($item);
				// }
				// this.$activeItem = this.moveToPrevious($item);
				this.$activeItem = ($parent.is('.vert-menu')) ? this.moveUpToPrev($item) : this.moveToPrevious($item);

				// sets focus to returned item
				this.$activeItem.focus();
				e.stopPropagation();
				return false;

			case this.keys.UP:
				// this.$activeItem = this.moveUp($item);
				this.$activeItem = ($parent.is('.vert-menu')) ? this.moveUpToPrev($item) : this.moveUp($item);
				this.$activeItem.focus();
				e.stopPropagation();
				return false;

			case this.keys.DOWN: 
				this.$activeItem = ($parent.is('.vert-menu')) ? this.moveDownToNext($item) : this.moveDown($item);
				this.$activeItem.focus();
				e.stopPropagation();
				return true ;

			case this.keys.ENTER:
			case this.keys.SPACE:
				if ($parent.is('.root-level') || $parent.is('.cat-thumbs') || $parent.is('.opt-trim') && !this.isInPanel) {
					this.$activeItem = this.moveDown($item);

					this.$activeItem.focus();
					e.stopPropagation();
					return false;
				}
				else { // process the menu choice
					console.log(e.target);
					if (e.target.tagName == "INPUT" || $(e.target).is('input') ) {

					} else {
						this.processMenuChoice($item);
					}
					e.stopPropagation ? e.stopPropagation() : (e.cancelBubble=true); // IE<9?
					/*// remove hover and focus styling
					this.$allItems.removeClass('menu-hover');
					this.$allItems.removeClass('menu-focus');
					// close the menu
					this.$id.find('ul').not('.root-level').attr('aria-hidden','true');*/
					// clear the active item
					this.$activeItem = null;
					// move focus to the text area
					// this.textarea.$id.focus();
					// TODO figure out how to continue with normal behaviour
					// e.stopPropagation();
					return true;
				}
				break;

			default: 
				if (e.target.tagName == "INPUT" || $(e.target).is('input') ) {
					console.log(e.keyCode);
					e.target.value += String.fromCharCode(e.which);
				}
				// e.stopPropagation ? e.stopPropagation() : (e.cancelBubble=true); // IE<9?
				return false;

		} // end switch

		// // e.stopPropagation();
		// return false;

	}; // end handleMenuKeyDown()

	// Function moveDownToNext is a special case for when moving down actually means
	// move to next sibling (for a normal veritcal menu)
	Menubar.prototype.moveDownToNext = function($item) {
		return $item.next();
	};

	// Function moveUpToNext is a special case for when moving up actually means
	// move to previous sibling (for a normal veritcal menu)
	Menubar.prototype.moveUpToPrev = function($item) {
		var $parent = $item.parent(),
			numChildren = $parent.children().length,
			isLastItem  = ($item.index() === numChildren-1) ? true : false,
			isFirstItem = ($item.index() === 0) ? true : false;

		return (isFirstItem) ? this.moveUp($item):$item.prev();
	};


	// Function moveToNext() is a member function to move to the next menu level.
	// This will be either the next root-level menu or the child of a menu parent. If
	// at the root level and the active item is the last in the menu, this function will loop
	// to the first menu item.
	// If the menu is a horizontal menu, the first child element of the newly selected menu will
	// be selected
	// @param($item object) $item is the active menu item
	// @return (object) Returns the item to move to. Returns $item is no move is possible
	Menubar.prototype.moveToNext = function($item) {

		var 
			$parent    = $item.parent(),          // $item's containing menu
			$menuItems = $parent.children(),      // the items in the currently active menu
			menuNum    = $menuItems.length,       // the number of items in the active menu
			menuIndex  = $menuItems.index($item), // the items index in its menu
			$newItem   = null,
			$newItemUL = null,
			$childMenu = null;

		if (this.isInPanel) {
			if (!this.isInPanel) {this.isInPanel = true;}
			$newItem = this.determineNextTabbable($item);
		}
		else if ($parent.is('.root-level') || $parent.is('.cat-thumbs') || $parent.is('.opt-trim')) {
			// this is the root level move to next sibling. This will require closing
			// the current child menu and opening the new one.

			// wrap around TODO consider changing to recursive tabbing?
			$newItem = (menuIndex < menuNum - 1) ? $item.next() : $menuItems.first();

			// close the current child menu (if applicable)

			// If current toggled item has a child showing, hide it
			if ($item.attr('aria-haspopup') == 'true') {
				$childMenu = $item.children('ul').first();
				if ($childMenu.attr('aria-hidden') == 'false') {
					// update the child menu's aria-hidden attribute
					// $childMenu.attr('aria-hidden', 'true');
					// this.bChildOpen = false;
				}
			}

			// remove the focus styling from the current menu
			$item.removeClass('menu-focus');

			/*// open the new child menu (if applicable)
			if (($newItem.attr('aria-haspopup') == 'true') && (this.bChildOpen == true)) {

				$childMenu = $newItem.children('ul').first();

				// Update the child's aria-hidden attribute
				$childMenu.attr('aria-hidden', 'false');


				 * Uncomment this section if the first item in the child menu should be
				 * automatically selected
				 *
				if (!this.vmenu) {
				   // select the first item in the child menu
				   $newItem = $childMenu.children('li').first();
				}


			}*/
		} 
		else if ( $parent.is('.upcoming') ) {
			// wrap around
			$newItem = (menuIndex < menuNum - 1) ? $item.next() : $menuItems.children().first();
		}
/*       else {
			// this is not the root level. If there is a child menu to be moved into, do that;
			// otherwise, move to the next root-level menu if there is one
			if ($item.attr('aria-haspopup') == 'true') {
				var $childMenu = $item.children('ul').first();
				$newItem = $childMenu.children('li').first();
				// show the child menu and update its aria attributes
				$childMenu.attr('aria-hidden', 'false');
			}
			else {
				// at deepest level, move to the next root-level menu
				if (this.vmenu == true) {
				// do nothing
				return $item;
				}
				var $parentMenus = null;
				var $rootItem = null;
				// get list of all parent menus for item, up to the root level
				$parentMenus = $item.parentsUntil('div').filter('ul').not('.root-level');
				// hide the current menu and update its aria attributes accordingly
				$parentMenus.attr('aria-hidden', 'true');
				// remove the focus styling from the active menu
				$parentMenus.find('li').removeClass('menu-focus');
				$parentMenus.last().parent().removeClass('menu-focus');

				$rootItem = $parentMenus.last().parent(); // the containing root for the menu

				menuIndex = this.$rootItems.index($rootItem);
				// if this is not the last root menu item, move to the next one
				if (menuIndex < this.$rootItems.length-1) {
				$newItem = $rootItem.next();
				} else { // loop
				$newItem = this.$rootItems.first();
				}

				// add the focus styling to the new menu
				$newItem.addClass('menu-focus');

				if ($newItem.attr('aria-haspopup') == 'true') {
					var $childMenu = $newItem.children('ul').first();

					$newItem = $childMenu.children('li').first();

					// show the child menu and update it's aria attributes
					$childMenu.attr('aria-hidden', 'false');
					this.bChildOpen == true;
				}
			}
		}*/

		return $newItem;
	};

	// Function moveToPrevious() is a member function to move to the previous menu level.
	// This will be either the previous root-level menu or the child of a menu parent. If
	// at the root level and the active item is the first in the menu, this function will loop
	// to the last menu item.
	// If the menu is a horizontal menu, the first child element of the newly selected menu will
	// be selected
	// @param($item object) $item is the active menu item
	// @return (object) Returns the item to move to. Returns $item is no move is possible
	Menubar.prototype.moveToPrevious = function($item) {

		var 
			$parent = $item.parent(), // $item's containing menu
			$menuItems = $parent.children(), // the items in the currently active menu
			menuNum = $menuItems.length, // the number of items in the active menu
			menuIndex = $menuItems.index($item), // the items index in its menu
			$newItem = null,
			$newItemUL = null;

		if (this.isInPanel) {
			$newItem = this.determineNextTabbable($item, "backward");
		}
		else if ( $parent.is('.root-level') || $parent.is('.cat-thumbs') || $parent.is('.opt-trim') ) {
			// this is the root level move to previous sibling. This will require closing
			// the current child menu and opening the new one.

			if (menuIndex > 0) { // not the first root menu
				$newItem = $item.prev();
			}
			else { // wrap to last item
				$newItem = $menuItems.last();
			}

			// remove the focus styling from the current menu
			$item.removeClass('menu-focus');

			// open the new child menu (if applicable)
			if ( ($newItem.attr('aria-haspopup') == 'true') && (this.bChildOpen === true) ) {

				// Update the child's aria-hidden attribute
				$newItem.children('ul').first().attr('aria-hidden', 'false');

				/*
				* Uncomment this section if the first item in the child menu should be
				* automatically selected
				*
				if (!this.vmenu) {
				// select the first item in the child menu
				$newItem = $childMenu.children('li').first();
				}
				*/

			}
		} else if ( $parent.is('.upcoming') ) {
			// wrap around
			$newItem = (menuIndex > 1) ? $item.prev() : $menuItems.children().last();
		}

		return $newItem;

	};

	// Function moveDown() is a member function to select the next item in a menu.
	// If the active item is the last in the menu, this function will loop to the
	// first menu item.
	// @param($item object) $item is the active menu item
	// @param(startChr char) [optional] startChr is the character to attempt to match against the beginning of the
	// menu item titles. If found, focus moves to the next menu item beginning with that character.
	// @return (object) Returns the item to move to. Returns $item is no move is possible
	Menubar.prototype.moveDown = function($item, startChr) {

		var $parent = $item.parent() ; // $item's containing menu
		// var $menuItems = $parent.children('li').not('.separator'); // the items in the currently active menu
		// var menuNum = $menuItems.length; // the number of items in the active menu
		// var menuIndex = $menuItems.index($item); // the items index in its menu
		var
			$newItem = null,
			$newItemUL = null,
			$checkedItem = null;

		// Basic menu selection, except for upcoming since it doesn't toggle
		if ( !$parent.is('.upcoming') ) {
			$item.attr('aria-checked',true).attr('aria-expanded',true).siblings().attr('aria-checked',false).attr('aria-expanded',false);
			$item.siblings().children().attr('aria-hidden',true).attr('aria-expanded',false);
			$item.children().attr('aria-hidden',false).attr('aria-expanded',true);
		}

		// There is little consistency, each level behaves slightly differently
		if ( $parent.is('.root-level') ) {
			$('.adn-mask').show();
		// - if exists, jump to (first) upcoming, otherwise (first) child of vert-menu
			$newItemUL = $item.children('ul').first();
			// if ($newItemUL.is('.vert-menu')) {alert('.vert-menu');}
			$checkedItem = $newItemUL.children().filter('[aria-checked=true]');
			$newItem = ($checkedItem.length) ? $checkedItem : $newItemUL.children().filter('[tabindex]').first();
		} 
		else if ( $parent.is('.upcoming') ) {
		// - jump to currently aria-checked cat-thumb, otherwise first cat-thumb
			$newItemUL = $parent.siblings('ul').first();
			$checkedItem = $newItemUL.children().filter('[aria-checked=true]');
			$newItem = ($checkedItem.length) ? $checkedItem : $newItemUL.children().filter('[tabindex]').first();
		}
		else if ( $parent.is('.cat-thumbs') ) {
		//	- if selected, jump to selected trim & aria-checked it, otherwise to first trim
			$newItemUL = $item.children('ul').first();
			if ($newItemUL.length) {
				$checkedItem = $newItemUL.children().filter('[aria-checked=true]');
				$newItem = ($checkedItem.length) ? $checkedItem : $newItemUL.children('.menu-item').first().attr('aria-checked',true);
				$newItem.children().attr('aria-hidden',false);
			}
			else { // there is no trim level
				$newItem = this.determineNextTabbable($item);
				this.isInPanel = true;
			}
			// set siblings to dimmed
			$('.cat-thumbs').children().removeClass('dimmed').end().children('[aria-checked=false]').addClass('dimmed');
		}
		else if ($parent.is('.opt-trim')) { 
		// Handle navigation within the content
			if (!this.isInPanel) {this.isInPanel = true;}
			$newItem = this.determineNextTabbable($item);
		}

		return $newItem;

/*       // if $item is not the last item in its menu, move to the next item. If startChr is specified, move
	   // to the next item with a title that begins with that character.
	   //
	   if (startChr) {
		  var bMatch = false;
		  var curNdx = menuIndex+1;

		  // check if the active item was the last one on the list
		  if (curNdx == menuNum) {
			 curNdx = 0;
		  }

		  // Iterate through the menu items (starting from the current item and wrapping) until a match is found
		  // or the loop returns to the current menu item
		  while (curNdx != menuIndex)  {

			 var titleChr = $menuItems.eq(curNdx).html().charAt(0);

			 if (titleChr.toLowerCase() == startChr) {
				bMatch = true;
				break;
			 }

			 curNdx = curNdx+1;

			 if (curNdx == menuNum) {
				// reached the end of the list, start again at the beginning
				curNdx = 0;
			 }
		  }

		  if (bMatch == true) {
			 $newItem = $menuItems.eq(curNdx);

			 // remove the focus styling from the current item
			 $item.removeClass('menu-focus');

			 return $newItem
		  }
		  else {
			 return $item;
		  }
	   }
	   else {
		  if (menuIndex < menuNum-1) {
			 $newItem = $menuItems.eq(menuIndex+1);
		  }
		  else {
			 $newItem = $menuItems.first();
		  }
	   }

	   // remove the focus styling from the current item
	   // $item.removeClass('menu-focus');

	   return $newItem;*/
	};

	// Function moveUp() is a member function to select the previous item in a menu.
	// If the active item is the first in the menu, this function will loop to the
	// last menu item.
	// @param($item object) $item is the active menu item
	// @return (object) Returns the item to move to. Returns $item is no move is possible
	Menubar.prototype.moveUp = function($item) {

		var 
			$parent    = $item.parent(),
		   $menuItems = $parent.children('li'),
		   menuNum    = $menuItems.length,
		   menuIndex  = $menuItems.index($item),
		   $newItem   = null,
		   $newItemUL = null;

		if ($parent.is('.root-level')) { // nothing to do
			$newItem = $item;
		}
		else if (this.isInPanel) {
			$newItem = this.determineNextTabbable($item, "backward");
		}
		else {
			$item.removeClass('menu-focus');
			$newItem = $parent.parent();
		}
		return $newItem;
	};

	// Function handleKeyPress() is a member function to process keydown events
	// for the menus.
	// The Opera browser performs some window commands from the keypress event,
	// not keydown like Firefox, Safari, and IE. This event handler consumes
	// keypresses for relevant keys so that Opera behaves when the user is
	// manipulating the menu with the keyboard.
	// @param($item object) $menu is the jquery object of the item firing the event
	// @param(e object) e is the associated event object
	// @return(boolean) Returns false if consuming; true if propagating
	Menubar.prototype.handleKeyPress = function($item, e) {

	   if (e.altKey || e.ctrlKey) {
		   // Modifier key pressed: Do not process
		   return true;
	   }

	   switch(e.keyCode) {
		  case this.keys.TAB: {
			 return true;
		  }
		  case this.keys.ESC:
		  case this.keys.ENTER:
		  case this.keys.SPACE:
		  case this.keys.UP:
		  case this.keys.DOWN:
		  case this.keys.LEFT:
		  case this.keys.RIGHT: {

			 e.stopPropagation();
			 return false;
		  }
		  default : {
			 var chr = String.fromCharCode(e.which);

			 this.$activeItem = this.moveDown($item, chr);
			 this.$activeItem.focus();

			 e.stopPropagation();
			 return false;
		  }

	   } // end switch

	   return true;

	}; // end handleKeyPress()

	// Function handleDocumentClick() is a member function to process click events on the document. Needed
	// to close an open menu if a user clicks outside the menu
	// @param(e object) e is the associated event object
	// @return(boolean) Returns true;
	Menubar.prototype.handleDocumentClick = function(e) {

		// get a list of all child menus
		var $childMenus = this.$id.find('ul').not('.root-level');

		// hide the child menus
		$childMenus.attr('aria-hidden', 'true');

		this.$allItems.removeClass('menu-focus').attr('aria-checked', false);

		// hide upcoming
		this.$upcoming.attr('aria-hidden', true);


		this.$activeItem = null;

		$('.adn-mask').hide();
		
		// set siblings to dimmed
		this.$catThumbs.children().removeClass('dimmed')

		// allow the event to propagate
		return true;

	}; // end handleDocumentClick()

	// Function processMenuChoice() is a member function to process the user's menu item
	// choice. Since the menu will close after this, highlight styling is simply removed.
	// @param($item object) $item is the jquery object of the menu item firing the event
	// @return N/A
	Menubar.prototype.processMenuChoice = function($item) {

	  // find the parent menu for this item
	  // var menuName = $item.parent().attr('id');
	  // var choice = $item.attr('id');

	  // console.log(menuName);

	  $item.find('a')[0].click();

/*      // call the appropriate textarea function
	  switch(menuName) {

		case 'menu-upcoming': {
		  // this.textarea.setFont(choice);

		  // update the aria-checked state of the menu items
		  $item.attr('aria-checked', 'true');
		  $item.siblings().attr('aria-checked', 'false');

		  $item.children()[0].click();

		  break;
		}
		case 'styleMenu': {
		  // this.textarea.setStyle(choice);

		  // reverse the aria-checked state
		  if ($item.attr('aria-checked') == 'true') {
			$item.attr('aria-checked', 'false');
		  }
		  else {
			$item.attr('aria-checked', 'true');
		  }

		  break;
		}
		case 'justificationMenu': {
		  // this.textarea.setAlignment(choice);

		  // update the aria-checked state of the menu items
		  $item.attr('aria-checked', 'true');
		  $item.siblings().attr('aria-checked', 'false');

		  break;
		}
		case 'sizeMenu': {
		  var $menuItems = $item.siblings().andSelf();
		  var $curItem;

		  this.textarea.setSize(choice);

		  ////////////////////////
		  // update the aria-checked state by first setting all items to false
		  // and then setting the item that matches the currently selected font
		  // size.

		  // set aria-checked to false and removed checked styling
		  $menuItems.attr('aria-checked', 'false');

		  // determine which menu item matches the current font size
		  $curItem = $menuItems.filter('[id=' + this.textarea.getSize() + ']');

		  // Set aria-checked for the matching item and apply the checked styling
		  $curItem.attr('aria-checked', 'true');

		  break;
		}
		default : {
		  // update the aria-checked state of the menu items
		  $item.attr('aria-checked', 'true');
		  $item.siblings().attr('aria-checked', 'false');

		}
	  } // end switch*/

	}; // end processMenuChoice()

	// Function to return $newItem for next tabbable element within .panel-content
	Menubar.prototype.determineNextTabbable = function($item, direction){

		var
			$panelItems = null,
			$newItem = null;

		$panelItems = $item.children('.panel-content').find('a, input:visible, button'); //[tabindex]?
		if ($panelItems){
			if (direction == "backward") {
				// TODO Stop at first
				if (this.panelItemIndex === 0 ) {
					this.isInPanel = false;
					$newItem = $item;// $panelItems[0];
				}
				else {
					$newItem =  $panelItems[this.panelItemIndex - 1]; 
				}
				--this.panelItemIndex;
			}
			else { // go forward, stopping at last
				if($panelItems.length == this.panelItemIndex + 1) {
					$newItem = $panelItems[this.panelItemIndex];
				}
				else {
					$newItem = $panelItems[this.panelItemIndex + 1]; 
					++this.panelItemIndex;
				}
			}
		}

		return $newItem;

	};

	/////////////// end menu widget definition /////////////////////

</script>

</body>
</html>